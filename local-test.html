<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”— Local Sync Timer Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        .notice {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .notice h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            background: #f8f9fa;
        }
        .section.connected {
            border-color: #28a745;
            background: #d4edda;
        }
        .section.host {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .section.participant {
            border-color: #17a2b8;
            background: #d1ecf1;
        }
        h2 {
            color: #34495e;
            margin-top: 0;
        }
        .form-group {
            margin: 1rem 0;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: background 0.2s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        button.success {
            background: #27ae60;
        }
        button.success:hover {
            background: #229954;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.error {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .timer-display {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 2rem 0;
            padding: 2rem;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
        }
        .timer-status {
            font-size: 1rem;
            margin-top: 0.5rem;
            opacity: 0.9;
        }
        .connections-list {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .user-item.host {
            background: #fff3cd;
        }
        .user-item.participant {
            background: #d1ecf1;
        }
        .user-icon {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .timer-display {
                font-size: 2rem;
            }
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”— æœ¬åœ°åŒæ­¥è®¡æ—¶å™¨æµ‹è¯•</h1>
            <p>ä½¿ç”¨BroadcastChannel APIæ¨¡æ‹Ÿå¤šæ ‡ç­¾é¡µåŒæ­¥</p>
        </div>

        <div class="notice">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p><strong>æœ¬åœ°æµ‹è¯•æ¨¡å¼</strong>ï¼šæ­¤é¡µé¢ä½¿ç”¨BroadcastChannel APIåœ¨åŒä¸€æµè§ˆå™¨çš„ä¸åŒæ ‡ç­¾é¡µä¹‹é—´æ¨¡æ‹ŸåŒæ­¥åŠŸèƒ½ã€‚</p>
            <p><strong>æµ‹è¯•æ­¥éª¤</strong>ï¼š</p>
            <ol>
                <li>åœ¨ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µä¸­åˆ›å»ºä¼šè¯ï¼ˆæˆä¸ºä¸»æŒäººï¼‰</li>
                <li>å¤åˆ¶æ­¤é¡µé¢åˆ°æ–°æ ‡ç­¾é¡µï¼ŒåŠ å…¥åŒä¸€ä¼šè¯ï¼ˆæˆä¸ºå‚ä¸è€…ï¼‰</li>
                <li>æµ‹è¯•ä¸»æŒäººæ§åˆ¶ï¼Œè§‚å¯Ÿå‚ä¸è€…åŒæ­¥</li>
            </ol>
        </div>

        <div class="status" id="connectionStatus">
            æœªè¿æ¥ - è¯·åˆ›å»ºæˆ–åŠ å…¥ä¼šè¯
        </div>

        <div class="timer-display" id="timerDisplay">
            10:00
            <div class="timer-status" id="timerStatus">å‡†å¤‡å¼€å§‹</div>
        </div>

        <div class="section" id="createSection">
            <h2>ğŸ¯ åˆ›å»ºä¼šè¯ï¼ˆä¸»æŒäººï¼‰</h2>
            <div class="form-group">
                <label for="hostName">ä¸»æŒäººå§“å</label>
                <input type="text" id="hostName" value="æœ¬åœ°æµ‹è¯•ä¸»æŒäºº" placeholder="è¾“å…¥æ‚¨çš„å§“å">
            </div>
            <div class="form-group">
                <label for="sessionName">ä¼šè¯åç§°</label>
                <input type="text" id="sessionName" value="æœ¬åœ°æµ‹è¯•ä¼šè¯" placeholder="è¾“å…¥ä¼šè¯åç§°">
            </div>
            <button onclick="createSession()">åˆ›å»ºä¼šè¯</button>
        </div>

        <div class="section" id="joinSection">
            <h2>ğŸ‘¥ åŠ å…¥ä¼šè¯ï¼ˆå‚ä¸è€…ï¼‰</h2>
            <div class="form-group">
                <label for="participantName">å‚ä¸è€…å§“å</label>
                <input type="text" id="participantName" value="æœ¬åœ°æµ‹è¯•å‚ä¸è€…" placeholder="è¾“å…¥æ‚¨çš„å§“å">
            </div>
            <div class="form-group">
                <label for="sessionCode">ä¼šè¯ä»£ç </label>
                <input type="text" id="sessionCode" placeholder="è¾“å…¥ä¼šè¯ä»£ç ">
            </div>
            <button onclick="joinSession()">åŠ å…¥ä¼šè¯</button>
        </div>

        <div class="section" id="controlSection" style="display: none;">
            <h2>ğŸ® è®¡æ—¶å™¨æ§åˆ¶</h2>
            <div class="controls">
                <button id="startBtn" onclick="startTimer()">å¼€å§‹</button>
                <button id="pauseBtn" onclick="pauseTimer()">æš‚åœ</button>
                <button id="resetBtn" onclick="resetTimer()">é‡ç½®</button>
                <button onclick="setTime(300)">è®¾ç½®5åˆ†é’Ÿ</button>
                <button onclick="setTime(600)">è®¾ç½®10åˆ†é’Ÿ</button>
                <button onclick="setTime(900)">è®¾ç½®15åˆ†é’Ÿ</button>
            </div>
            <button class="danger" onclick="leaveSession()">ç¦»å¼€ä¼šè¯</button>
        </div>

        <div class="section" id="infoSection" style="display: none;">
            <h2>ğŸ“Š ä¼šè¯ä¿¡æ¯</h2>
            <div id="sessionInfo">
                <p><strong>ä¼šè¯ä»£ç ï¼š</strong><span id="displaySessionCode">-</span></p>
                <p><strong>æˆ‘çš„è§’è‰²ï¼š</strong><span id="myRole">-</span></p>
                <p><strong>ä¼šè¯åç§°ï¼š</strong><span id="displaySessionName">-</span></p>
            </div>
            
            <h3>ğŸ‘¥ è¿æ¥çš„ç”¨æˆ·</h3>
            <div class="connections-list" id="connectionsList">
                <div class="user-item">
                    <span class="user-icon">ğŸ‘¤</span>
                    <span>æš‚æ— è¿æ¥</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div class="log" id="debugLog">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        // æœ¬åœ°åŒæ­¥è®¡æ—¶å™¨ç±»
        class LocalSyncTimer {
            constructor() {
                this.sessionId = null;
                this.userType = null; // 'host' or 'participant'
                this.userName = null;
                this.isConnected = false;
                
                // è®¡æ—¶å™¨çŠ¶æ€
                this.timerState = {
                    totalSeconds: 600,
                    remainingSeconds: 600,
                    isRunning: false,
                    isPaused: false,
                    startTime: null
                };
                
                // ä¼šè¯æ•°æ®
                this.sessionData = {
                    sessionId: null,
                    sessionName: null,
                    hostName: null,
                    participants: []
                };
                
                // è®¡æ—¶å™¨é—´éš”
                this.timerInterval = null;
                
                // BroadcastChannel for cross-tab communication
                this.channel = null;
                
                this.log('LocalSyncTimer initialized');
            }
            
            // åˆ›å»ºä¼šè¯
            async createSession(hostName, sessionName) {
                const sessionId = this.generateSessionId();
                
                this.sessionId = sessionId;
                this.userType = 'host';
                this.userName = hostName;
                this.isConnected = true;
                
                this.sessionData = {
                    sessionId,
                    sessionName,
                    hostName,
                    participants: [{
                        name: hostName,
                        type: 'host',
                        id: 'host-' + Date.now()
                    }]
                };
                
                // åˆ›å»ºå¹¿æ’­é¢‘é“
                this.channel = new BroadcastChannel(`timer-session-${sessionId}`);
                this.channel.onmessage = (event) => this.handleMessage(event.data);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(`session-${sessionId}`, JSON.stringify({
                    sessionData: this.sessionData,
                    timerState: this.timerState,
                    createdAt: new Date().toISOString()
                }));
                
                this.log(`Session created: ${sessionId}`);
                this.updateUI();
                
                return {
                    success: true,
                    sessionId,
                    sessionName
                };
            }
            
            // åŠ å…¥ä¼šè¯
            async joinSession(sessionCode, participantName) {
                // æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨
                const sessionKey = `session-${sessionCode}`;
                const sessionData = localStorage.getItem(sessionKey);
                
                if (!sessionData) {
                    throw new Error('Session not found');
                }
                
                const session = JSON.parse(sessionData);
                
                this.sessionId = sessionCode;
                this.userType = 'participant';
                this.userName = participantName;
                this.isConnected = true;
                
                this.sessionData = session.sessionData;
                this.timerState = session.timerState;
                
                // æ·»åŠ å‚ä¸è€…åˆ°åˆ—è¡¨
                const participantId = 'participant-' + Date.now();
                this.sessionData.participants.push({
                    name: participantName,
                    type: 'participant',
                    id: participantId
                });
                
                // æ›´æ–°å­˜å‚¨
                localStorage.setItem(sessionKey, JSON.stringify({
                    sessionData: this.sessionData,
                    timerState: this.timerState,
                    createdAt: session.createdAt
                }));
                
                // åˆ›å»ºå¹¿æ’­é¢‘é“
                this.channel = new BroadcastChannel(`timer-session-${sessionCode}`);
                this.channel.onmessage = (event) => this.handleMessage(event.data);
                
                // å¹¿æ’­åŠ å…¥æ¶ˆæ¯
                this.broadcast({
                    type: 'USER_JOINED',
                    user: {
                        name: participantName,
                        type: 'participant',
                        id: participantId
                    },
                    sessionData: this.sessionData
                });
                
                this.log(`Joined session: ${sessionCode}`);
                this.updateUI();
                
                return {
                    success: true,
                    sessionId: sessionCode,
                    sessionName: this.sessionData.sessionName
                };
            }
            
            // å¤„ç†å¹¿æ’­æ¶ˆæ¯
            handleMessage(data) {
                this.log(`Received: ${data.type}`);
                
                switch (data.type) {
                    case 'TIMER_UPDATE':
                        this.timerState = data.timerState;
                        this.updateTimerDisplay();
                        break;
                        
                    case 'TIMER_START':
                        this.timerState = data.timerState;
                        this.startLocalTimer();
                        this.updateTimerDisplay();
                        break;
                        
                    case 'TIMER_PAUSE':
                        this.timerState = data.timerState;
                        this.stopLocalTimer();
                        this.updateTimerDisplay();
                        break;
                        
                    case 'TIMER_RESET':
                        this.timerState = data.timerState;
                        this.stopLocalTimer();
                        this.updateTimerDisplay();
                        break;
                        
                    case 'TIME_SET':
                        this.timerState = data.timerState;
                        this.updateTimerDisplay();
                        break;
                        
                    case 'USER_JOINED':
                        this.sessionData = data.sessionData;
                        this.updateConnectionsList();
                        break;
                        
                    case 'USER_LEFT':
                        this.sessionData = data.sessionData;
                        this.updateConnectionsList();
                        break;
                }
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                this.saveSession();
            }
            
            // å¹¿æ’­æ¶ˆæ¯
            broadcast(message) {
                if (this.channel) {
                    this.channel.postMessage(message);
                }
            }
            
            // è®¡æ—¶å™¨æ§åˆ¶æ–¹æ³•
            startTimer() {
                if (this.userType !== 'host') {
                    this.log('Only host can control timer');
                    return false;
                }
                
                this.timerState.isRunning = true;
                this.timerState.isPaused = false;
                this.timerState.startTime = Date.now();
                
                this.startLocalTimer();
                
                this.broadcast({
                    type: 'TIMER_START',
                    timerState: this.timerState
                });
                
                this.updateTimerDisplay();
                this.saveSession();
                this.log('Timer started');
                return true;
            }
            
            pauseTimer() {
                if (this.userType !== 'host') {
                    this.log('Only host can control timer');
                    return false;
                }
                
                this.timerState.isRunning = false;
                this.timerState.isPaused = true;
                
                this.stopLocalTimer();
                
                this.broadcast({
                    type: 'TIMER_PAUSE',
                    timerState: this.timerState
                });
                
                this.updateTimerDisplay();
                this.saveSession();
                this.log('Timer paused');
                return true;
            }
            
            resetTimer() {
                if (this.userType !== 'host') {
                    this.log('Only host can control timer');
                    return false;
                }
                
                this.timerState.isRunning = false;
                this.timerState.isPaused = false;
                this.timerState.remainingSeconds = this.timerState.totalSeconds;
                this.timerState.startTime = null;
                
                this.stopLocalTimer();
                
                this.broadcast({
                    type: 'TIMER_RESET',
                    timerState: this.timerState
                });
                
                this.updateTimerDisplay();
                this.saveSession();
                this.log('Timer reset');
                return true;
            }
            
            setTime(seconds) {
                if (this.userType !== 'host') {
                    this.log('Only host can control timer');
                    return false;
                }
                
                if (this.timerState.isRunning) {
                    this.log('Cannot set time while timer is running');
                    return false;
                }
                
                this.timerState.totalSeconds = seconds;
                this.timerState.remainingSeconds = seconds;
                
                this.broadcast({
                    type: 'TIME_SET',
                    timerState: this.timerState
                });
                
                this.updateTimerDisplay();
                this.saveSession();
                this.log(`Time set to ${seconds} seconds`);
                return true;
            }
            
            // æœ¬åœ°è®¡æ—¶å™¨ç®¡ç†
            startLocalTimer() {
                this.stopLocalTimer();
                this.timerInterval = setInterval(() => {
                    if (this.timerState.remainingSeconds > 0) {
                        this.timerState.remainingSeconds--;
                        this.updateTimerDisplay();
                        
                        // åªæœ‰ä¸»æŒäººå¹¿æ’­æ›´æ–°
                        if (this.userType === 'host') {
                            this.broadcast({
                                type: 'TIMER_UPDATE',
                                timerState: this.timerState
                            });
                        }
                    } else {
                        this.timerComplete();
                    }
                }, 1000);
            }
            
            stopLocalTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }
            
            timerComplete() {
                this.timerState.isRunning = false;
                this.timerState.remainingSeconds = 0;
                this.stopLocalTimer();
                this.updateTimerDisplay();
                this.log('Timer completed!');
                
                // æ’­æ”¾æé†’éŸ³
                this.playNotificationSound();
            }
            
            // ç¦»å¼€ä¼šè¯
            leaveSession() {
                if (this.channel) {
                    // ä»å‚ä¸è€…åˆ—è¡¨ä¸­ç§»é™¤è‡ªå·±
                    this.sessionData.participants = this.sessionData.participants.filter(
                        p => p.name !== this.userName
                    );
                    
                    this.broadcast({
                        type: 'USER_LEFT',
                        sessionData: this.sessionData
                    });
                    
                    this.channel.close();
                    this.channel = null;
                }
                
                this.stopLocalTimer();
                this.isConnected = false;
                this.sessionId = null;
                this.userType = null;
                this.userName = null;
                
                this.updateUI();
                this.log('Left session');
            }
            
            // UIæ›´æ–°æ–¹æ³•
            updateUI() {
                const status = document.getElementById('connectionStatus');
                const createSection = document.getElementById('createSection');
                const joinSection = document.getElementById('joinSection');
                const controlSection = document.getElementById('controlSection');
                const infoSection = document.getElementById('infoSection');
                
                if (this.isConnected) {
                    status.textContent = `å·²è¿æ¥ - ${this.userType === 'host' ? 'ä¸»æŒäºº' : 'å‚ä¸è€…'}: ${this.userName}`;
                    status.className = 'status connected';
                    
                    createSection.style.display = 'none';
                    joinSection.style.display = 'none';
                    controlSection.style.display = 'block';
                    infoSection.style.display = 'block';
                    
                    // æ›´æ–°ä¼šè¯ä¿¡æ¯
                    document.getElementById('displaySessionCode').textContent = this.sessionId;
                    document.getElementById('myRole').textContent = this.userType === 'host' ? 'ä¸»æŒäºº' : 'å‚ä¸è€…';
                    document.getElementById('displaySessionName').textContent = this.sessionData.sessionName;
                    
                    // ç¦ç”¨å‚ä¸è€…æ§åˆ¶
                    if (this.userType === 'participant') {
                        const buttons = controlSection.querySelectorAll('button:not(.danger)');
                        buttons.forEach(btn => {
                            btn.disabled = true;
                            btn.title = 'åªæœ‰ä¸»æŒäººå¯ä»¥æ§åˆ¶è®¡æ—¶å™¨';
                        });
                        controlSection.classList.add('participant');
                    } else {
                        controlSection.classList.add('host');
                    }
                    
                    this.updateConnectionsList();
                } else {
                    status.textContent = 'æœªè¿æ¥ - è¯·åˆ›å»ºæˆ–åŠ å…¥ä¼šè¯';
                    status.className = 'status disconnected';
                    
                    createSection.style.display = 'block';
                    joinSection.style.display = 'block';
                    controlSection.style.display = 'none';
                    infoSection.style.display = 'none';
                }
            }
            
            updateTimerDisplay() {
                const minutes = Math.floor(this.timerState.remainingSeconds / 60);
                const seconds = this.timerState.remainingSeconds % 60;
                const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timerDisplay').innerHTML = `
                    ${display}
                    <div class="timer-status" id="timerStatus">${this.getTimerStatusText()}</div>
                `;
            }
            
            getTimerStatusText() {
                if (this.timerState.isRunning) {
                    return 'è¿è¡Œä¸­...';
                } else if (this.timerState.isPaused) {
                    return 'å·²æš‚åœ';
                } else if (this.timerState.remainingSeconds === 0) {
                    return 'å·²å®Œæˆ! ğŸ‰';
                } else {
                    return 'å‡†å¤‡å¼€å§‹';
                }
            }
            
            updateConnectionsList() {
                const list = document.getElementById('connectionsList');
                list.innerHTML = '';
                
                this.sessionData.participants.forEach(participant => {
                    const item = document.createElement('div');
                    item.className = `user-item ${participant.type}`;
                    item.innerHTML = `
                        <span class="user-icon">${participant.type === 'host' ? 'ğŸ‘‘' : 'ğŸ‘¤'}</span>
                        <span>${participant.name} (${participant.type === 'host' ? 'ä¸»æŒäºº' : 'å‚ä¸è€…'})</span>
                    `;
                    list.appendChild(item);
                });
            }
            
            // å·¥å…·æ–¹æ³•
            generateSessionId() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }
            
            saveSession() {
                if (this.sessionId) {
                    localStorage.setItem(`session-${this.sessionId}`, JSON.stringify({
                        sessionData: this.sessionData,
                        timerState: this.timerState,
                        createdAt: new Date().toISOString()
                    }));
                }
            }
            
            playNotificationSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Could not play notification sound:', e);
                }
            }
            
            log(message) {
                const logEl = document.getElementById('debugLog');
                const time = new Date().toLocaleTimeString();
                logEl.innerHTML += `[${time}] ${message}<br>`;
                logEl.scrollTop = logEl.scrollHeight;
                console.log(`[${time}] ${message}`);
            }
        }
        
        // å…¨å±€å®ä¾‹
        let syncTimer = new LocalSyncTimer();
        
        // é¡µé¢æ§åˆ¶å‡½æ•°
        async function createSession() {
            const hostName = document.getElementById('hostName').value.trim();
            const sessionName = document.getElementById('sessionName').value.trim();
            
            if (!hostName || !sessionName) {
                alert('è¯·è¾“å…¥ä¸»æŒäººå§“åå’Œä¼šè¯åç§°');
                return;
            }
            
            try {
                const result = await syncTimer.createSession(hostName, sessionName);
                alert(`ä¼šè¯åˆ›å»ºæˆåŠŸï¼\nä¼šè¯ä»£ç : ${result.sessionId}\n\nè¯·åœ¨æ–°æ ‡ç­¾é¡µä¸­ä½¿ç”¨æ­¤ä»£ç åŠ å…¥ä¼šè¯è¿›è¡Œæµ‹è¯•ã€‚`);
            } catch (error) {
                alert('åˆ›å»ºä¼šè¯å¤±è´¥: ' + error.message);
            }
        }
        
        async function joinSession() {
            const participantName = document.getElementById('participantName').value.trim();
            const sessionCode = document.getElementById('sessionCode').value.trim().toUpperCase();
            
            if (!participantName || !sessionCode) {
                alert('è¯·è¾“å…¥å‚ä¸è€…å§“åå’Œä¼šè¯ä»£ç ');
                return;
            }
            
            try {
                await syncTimer.joinSession(sessionCode, participantName);
                alert(`æˆåŠŸåŠ å…¥ä¼šè¯: ${sessionCode}`);
            } catch (error) {
                alert('åŠ å…¥ä¼šè¯å¤±è´¥: ' + error.message);
            }
        }
        
        function startTimer() {
            syncTimer.startTimer();
        }
        
        function pauseTimer() {
            syncTimer.pauseTimer();
        }
        
        function resetTimer() {
            syncTimer.resetTimer();
        }
        
        function setTime(seconds) {
            syncTimer.setTime(seconds);
        }
        
        function leaveSession() {
            if (confirm('ç¡®å®šè¦ç¦»å¼€ä¼šè¯å—ï¼Ÿ')) {
                syncTimer.leaveSession();
            }
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        // åˆå§‹åŒ–
        syncTimer.updateUI();
        syncTimer.updateTimerDisplay();
        syncTimer.log('Local sync timer test page loaded');
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (syncTimer.isConnected) {
                syncTimer.leaveSession();
            }
        });
    </script>
</body>
</html> 